<!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <title>Azure Active Directory Application Registration</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
        <link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        
        <script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
    </head>
    <body>
        <link href="images/style.css" rel="stylesheet"></link>
<h1 id="azure-active-directory-application-registration">Azure Active Directory Application Registration</h1>
<h2 id="azure-active-directory-application-registration-and-provisioning">Azure Active Directory Application Registration and Provisioning</h2>
<p>Azure Active Directory Application Registration (AAD App Registration) and configuration can be performed by setting up a provisioning job in Azure DevOps.</p>
<p>Everything starts with a GithHub repository that contains build definition in <strong>azure-pipelines.ym</strong>l, configuration for AAD Resource Access that is stored in <strong>resourceAccess.json</strong>, infrastructure code as Azure Resource Manager template for provisioning a website <strong>Infrastructure/azuredeploy.json</strong>.</p>
<p>Example app provisioning GitHub repo can be found in <a href="https://github.com/hmcts/vh-example-api-provisioning">vh-example-api-provisioning repo</a>. You can copy the repo’s content to your application provisioning repo and amend accordingly.</p>
<h2 id="github-repository">GitHub repository</h2>
<p>Once GitHub repository has been created you need to configure it accordingly:</p>
<ul>
<li>Collaborators &amp; teams
<ul>
<li>Reform - Read</li>
<li>VH - Admin</li>
<li>DevOps - Admin</li>
</ul>
</li>
</ul>
<p><img src="file:///images/github_repo_permissions.png#thumbnail" alt="GitHub repo Permissions"></p>
<ul>
<li>Branches
<ul>
<li>master - Require pull request reviews before merging
[Virtual Hearings &gt; Azure Active Directory Application Regisration &gt; image2019-2-28_14-25-56.png]</li>
</ul>
</li>
</ul>
<p>You need to add the correct teams to the repository so that members form these teams can edit the repo's content and so that Azure DevOps pipelines can checkout the source and report back the status of builds.</p>
<p>[Virtual Hearings &gt; Azure Active Directory Application Regisration &gt; image2019-2-28_14-27-38.png]
Build definition - azure-pipelines.yml</p>
<p>The content of azure-pipelines.yml defines the build pipeline for AAD App registration and Web App provisioning. As an example we can provision new application vh-example-api. In the azure-pipelines.yml file we need to update two variables accordingly - appName, aadAppReplyUrls.</p>
<p>variables:</p>
<ul>
<li>
<p>group: 'vh-vsts-automation'  # variable group</p>
</li>
<li>
<p>group: 'Azure AD Tenant - <a href="http://hearings.reform.hmcts.net">hearings.reform.hmcts.net</a>'</p>
</li>
<li>
<p>group: 'vh-hearings-ssl-certificates'</p>
</li>
<li>
<p>group: 'vh-hearings-reform-hmcts-net-dns-zone'</p>
</li>
<li>
<p>name: appName
value: vh-example-api # name of the app to be registered and provisioned</p>
</li>
<li>
<p>name: WebSiteName
value: <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mi>a</mi><mi>p</mi><mi>p</mi><mi>N</mi><mi>a</mi><mi>m</mi><mi>e</mi><mo>)</mo><mo>−</mo></mrow><annotation encoding="application/x-tex">(appName)-</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord mathdefault">p</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mclose">)</span><span class="mord">−</span></span></span></span>(environmentName) # web site name &quot;$(environmentName)&quot; is set during runtime from GUI.</p>
</li>
<li>
<p>name: aadAppReplyUrls
value: https://<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mi>W</mi><mi>e</mi><mi>b</mi><mi>S</mi><mi>i</mi><mi>t</mi><mi>e</mi><mi>N</mi><mi>a</mi><mi>m</mi><mi>e</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">(WebSiteName)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mord mathdefault">e</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mclose">)</span></span></span></span>(AzureAppServiceWebSiteCustomDomainName)/ #CSV list of replay urls</p>
</li>
</ul>
<h1 id="github-repo-that-conatins-build-templates-reference-httpsdocsmicrosoftcomen-usazuredevopspipelinesprocesstemplatesviewvstsusing-other-repositories">GitHub Repo that conatins build templates. Reference <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=vsts#using-other-repositories">https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=vsts#using-other-repositories</a></h1>
<p>resources:
repositories:</p>
<ul>
<li>repository: azureDevOpsTemplates
type: github
name: hmcts/azure-devops-templates
#ref: refs/heads/master  # ref name to use, defaults to 'refs/heads/master'
endpoint: 'GitHubDevOps'</li>
</ul>
<p>trigger:</p>
<ul>
<li>master
pr:</li>
<li>master</li>
</ul>
<p>jobs:</p>
<ul>
<li>template: jobs/aadAppRegistration.yml@azureDevOpsTemplates # Template reference
parameters:
appName: $(appName)
aadAppReplyUrls: $(aadAppReplyUrls)</li>
</ul>
<p>AAD Resource access - resourceAccess.json</p>
<p>If the registered application requires access to Microsoft Grap API this can be granted using the AAD GUI as shown below but the preferred way is to use resourceAccess.json. By using resourceAccess.json we can source control the permissions and this will guarantee consistency across all environments.</p>
<p>Example resourceAccess.json:</p>
<p>{
&quot;requiredResourceAccess&quot;: [
{
&quot;resourceAppName&quot;: &quot;Microsoft.Azure.ActiveDirectory&quot;,
&quot;resourceAppId&quot;: &quot;00000002-0000-0000-c000-000000000000&quot;,
&quot;resourceAccess&quot;: [
{
&quot;resourceAccessName&quot;: &quot;Sign in and read user profile&quot;,
&quot;id&quot;: &quot;311a71cc-e848-46a1-bdf8-97ff7156d8e6&quot;,
&quot;type&quot;: &quot;Scope&quot;
}
]
}
]
}</p>
<p>GUI:</p>
<p>[Virtual Hearings &gt; Azure Active Directory Application Regisration &gt; image2019-2-28_15-20-56.png]
GUI Manifest:</p>
<p>[Virtual Hearings &gt; Azure Active Directory Application Regisration &gt; image2019-2-28_15-21-45.png]
Group Membership Claims</p>
<p>To add Group Membership Claims to AAD app a new variable has to be added to the yaml build pipeline:</p>
<p>variables:
- name: groupMembershipClaims # Available values: SecurityGroup, All
value: SecurityGroup</p>
<p>jobs:</p>
<ul>
<li>template: jobs/aadAppRegistration.yml@azureDevOpsTemplates # Template reference
parameters:
appName: $(appName)
aadAppReplyUrls: $(aadAppReplyUrls)
groupMembershipClaims: $(groupMembershipClaims)</li>
</ul>
<p>Full template example - <a href="https://github.com/hmcts/vh-example-api-provisioning/blob/master/azure-pipelines.yml">https://github.com/hmcts/vh-example-api-provisioning/blob/master/azure-pipelines.yml</a>
Infrastructure</p>
<p>Each provisioning project has to have the Infrastructure code. This ARM template will automatically provision a WebApp that will be used during the actual application deployment. In most cases default values in the infrastructure code will be enough.
Azure DevOps Pipeline</p>
<p>Once the repo has been created and the required content has been committed to the repo it's time to create a build pipeline that will be used to provision the application. The easiest way to create new build pipeline is to clone an existing pipeline. As an example we can use hmcts.vh-example-api-provisioning. When pipeline is cloned all the variables and variable groups required for running the provisioning job get cloned as well. It is mandatory to link the variable groups and variables defined in the build definition to the build pipeline!
Cloning the pipeline</p>
<p>[Virtual Hearings &gt; Azure Active Directory Application Regisration &gt; image2019-2-28_15-26-40.png]</p>
<p>After cloning the pipeline we need to makes some adjustments:</p>
<pre><code>Pipeline Name - changed it to the same name as the repository / application name
Service Connection - make sure it is set to GitHubDevOps
Repository - make sure it is set to repository containing source code
</code></pre>
<p>[Virtual Hearings &gt; Azure Active Directory Application Regisration &gt; image2019-2-28_15-37-3.png]
Provisioning</p>
<p>Once the pipeline has been configured select &quot;Save &amp; Queue&quot;. This will now queue a job to provision the application for &quot;Preview&quot; environment. The &quot;Preview&quot; environment has been set as the default environment.</p>
<p>One the resourceAccess.json and azure-pipelines.yml files have been amended accordingly and tested in preview environment we can start provisioning the applications in other environments like sandbox. To provision the application in sandbox environment we need to change the &quot;EnvironmentName&quot; at queue time. To do that queue new job:</p>
<p>[Virtual Hearings &gt; Azure Active Directory Application Regisration &gt; image2019-2-28_15-55-40.png]</p>
<p><a href="https://raw.githubusercontent.com/hmcts/vh-ps-modules/master/README.md">https://raw.githubusercontent.com/hmcts/vh-ps-modules/master/README.md</a></p>

    </body>
    </html>